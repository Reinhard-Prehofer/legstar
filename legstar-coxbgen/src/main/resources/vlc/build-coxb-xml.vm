<!-- =================================================================================
     This script generates JAXB classes from a COBOL-annotated XML schema. It then
     goes on and generates binding classes for selected JAXB root classes.
     Binding classes provide an efficient runtime code for visitors. They avoid
     reflection and use of annotations at runtime.
  -->
<project basedir="${model.productLocation}" default="signalSuccess" name="generate-COXB-classes">

    <!-- ===========================================================  -->
    <!-- Setup environment
    -->
    <target name="init">
    
        <!-- Classpath setting -->
        <path id="classpath">
            <fileset dir="${basedir}" includes="lib/*.jar" />
            <!--JAXB generated classes (needed for reflection) -->
            <dirset dir="${model.jaxbBinDir}"/>
        </path>
        
        <!-- Regular Sun JAXB XJC tool ant task  -->
        <taskdef name="xjc"
            classname="com.sun.tools.xjc.XJC2Task"
            classpathref="classpath"/>
        
        <!-- Binding generator ant task -->
        <taskdef name="coxbgen"
            classname="com.legstar.coxb.gen.CoxbBindingGenerator"
            classpathref="classpath"/>
        
        <!-- Make sure target directories exist -->
        <mkdir dir="${model.jaxbSrcDir}"/>
        <mkdir dir="${model.jaxbBinDir}"/>
    
    </target>

    <!-- ===========================================================  -->
    <!-- Generate the JAXB classes source
    -->
    <target name="generateJAXB" depends="init">
        <echo message="Generating JAXB classes for ${model.xsdFile}" />
        <xjc schema="${model.xsdFile}" destdir="${model.jaxbSrcDir}" extension="true" removeOldOutput="yes">
            <!--COXB xjc plugin extension-->
            <arg value="-Xlegstar-code" />
            <!--Without this option (no validation), out of memory errors -->
            <arg value="-nv" />
            <!-- External XJC bindings directory. Collects all *.xjb files -->
            <arg value="-b" />
            <arg value="${model.jaxbXjcBindingDir}" />
        </xjc>
    </target>

    <!-- ===========================================================  -->
    <!-- Compile the generated JAXB classes. fork="no" prevents
    the bug on package-info.java
    -->
    <target name="compileJAXB" depends="generateJAXB">
        <javac srcdir="${model.jaxbSrcDir}"
            destdir="${model.jaxbBinDir}"
            classpathref="classpath"
            fork="no"
        />
    </target>
  
    <!-- ===========================================================  -->
    <!-- Generate binding classes by reflecting on JAXB classes.
    -->
    <target name="generateCOXB" depends="compileJAXB">
        <echo message="Generating binding classes for ${model.xsdFile}" />
        <coxbgen 
            xsdFile="${model.xsdFile}"
            jaxbTypeNameSuffix="${model.jaxbTypeNameSuffix}"
            targetDir="${model.coxbSrcDir}"
            >
#foreach ($jaxbRootClassName in $model.jaxbRootClassNames)
            <jaxbRootClass name="${jaxbRootClassName}"/>
#end
        </coxbgen>
    </target>

    <!-- ===========================================================  -->
    <!-- Compile the generated binding classes.
    -->
    <target name="compileCOXB" depends="generateCOXB">
        <javac srcdir="${model.coxbSrcDir}"
            destdir="${model.coxbBinDir}"
            classpathref="classpath"
            fork="yes"
        />
    </target>
  
    <!-- ===========================================================  -->
    <!-- Delete the probe file to signal success
    -->
    <target name="signalSuccess" depends="generateCOXB">
        <delete file="${model.probeFile}" quiet="true"/>
    </target>
    
</project>
